name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Changed from read to write for commenting
      issues: write         # Changed from read to write for commenting
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Setup GitHub CLI
        run: |
          if command -v gh &> /dev/null; then
            echo "âœ… gh CLI already installed"
            gh --version
          else
            echo "ðŸ“¦ Installing gh CLI..."
            (type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)) \
            && sudo mkdir -p -m 755 /etc/apt/keyrings \
            && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
            && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y
            gh --version
          fi

      - name: Configure gh CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Configuring gh CLI authentication..."
          gh auth status || echo "gh CLI authentication configured"

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}
            PR AUTHOR: ${{ github.event.pull_request.user.login }}
            PR BRANCH: ${{ github.event.pull_request.head.ref }}

            Review this pull request with focus on:

            **Critical Issues:**
            - Security vulnerabilities (XSS, injection, hardcoded secrets)
            - HIPAA compliance for PHI handling
            - Type safety issues that could cause runtime errors
            - Memory leaks or performance bottlenecks

            **Code Quality:**
            - Best practices and design patterns
            - Code readability and maintainability
            - Proper error handling
            - Test coverage

            **Post-Quantum Cryptography (if applicable):**
            - Verify PQC implementation uses real cryptography (no simulations)
            - Check NIST-approved algorithms (Kyber, Dilithium)
            - Validate key management and rotation

            Read CLAUDE.md for project conventions. Be constructive and actionable.

            **To post your review:**
            Use: `gh pr comment ${{ github.event.pull_request.number }} --body "YOUR_REVIEW_HERE"`

            **If gh fails:** Output review to stdout as markdown.

          claude_args: '--allowed-tools "Bash(gh *)"'

      - name: Review Status Summary
        if: always()
        run: |
          echo "## Claude Code Review Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.claude-review.outcome }}" == "failure" ]; then
            echo "âš ï¸ Claude Code Review encountered an error" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
            echo "- Missing CLAUDE_CODE_OAUTH_TOKEN secret" >> $GITHUB_STEP_SUMMARY
            echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
            echo "- gh CLI authentication problems" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This is non-blocking** - the PR can still be merged after manual review." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.claude-review.outcome }}" == "success" ]; then
            echo "âœ… Claude Code Review completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the PR comments for detailed feedback." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Claude Code Review was skipped" >> $GITHUB_STEP_SUMMARY
          fi

