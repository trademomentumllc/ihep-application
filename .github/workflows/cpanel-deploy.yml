name: Deploy to cPanel

on:
  push:
    branches:
      - main
      - production
      - claude/sync-cpanel-deployment-*
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '22'
  DEPLOY_PATH: '/home/ihepapp/public_html'

jobs:
  deploy:
    name: Deploy to cPanel Hosting
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://ihep.app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy-package

          # Copy necessary files for deployment
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp next.config.mjs deploy-package/

          # Copy standalone build if it exists
          if [ -d ".next/standalone" ]; then
            cp -r .next/standalone/* deploy-package/
          fi

          # Create .htaccess
          cat > deploy-package/.htaccess << 'EOF'
          # Force HTTPS
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # Proxy to Node.js application
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ http://localhost:3000/$1 [P,L]

          # Security headers
          Header always set X-Content-Type-Options "nosniff"
          Header always set X-Frame-Options "SAMEORIGIN"
          Header always set X-XSS-Protection "1; mode=block"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"
          Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"

          # HSTS (only for production)
          Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

          # Cache static assets
          <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "max-age=31536000, public, immutable"
          </FilesMatch>

          # Prevent access to sensitive files
          <FilesMatch "^\.env|^\.git|package-lock\.json|tsconfig\.json">
            Order allow,deny
            Deny from all
          </FilesMatch>
          EOF

          # Create deployment info file
          cat > deploy-package/deployment-info.json << EOF
          {
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "branch": "${{ github.ref_name }}",
            "deployed_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CPANEL_SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.CPANEL_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via rsync over SSH
        run: |
          rsync -avz --progress \
            --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=no" \
            deploy-package/ \
            ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Install dependencies on remote server
        run: |
          ssh ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}

            # Use cPanel's Node.js version selector if available
            # source /home/ihepapp/nodevenv/public_html/22/bin/activate 2>/dev/null || true

            # Install production dependencies
            npm install --production --prefer-offline --no-audit

            # Set correct permissions
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;

            # Restart Node.js application
            # Option 1: If using PM2
            if command -v pm2 &> /dev/null; then
              pm2 restart ihep-app || pm2 start npm --name "ihep-app" -- start
              pm2 save
            fi

            # Option 2: If using Passenger (cPanel Node.js Application)
            mkdir -p tmp
            touch tmp/restart.txt

            echo "Deployment completed successfully at $(date)"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "Waiting for application to restart..."
          sleep 10

          # Check if the site is accessible
          curl -f -I https://ihep.app/ || {
            echo "Warning: Site health check failed"
            echo "Please verify manually at https://ihep.app"
          }

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ SUCCESS"
            COLOR="good"
          else
            STATUS="❌ FAILED"
            COLOR="danger"
          fi

          echo "Deployment $STATUS"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "URL: https://ihep.app"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed. Consider implementing rollback mechanism."
          echo "Manual rollback may be required via cPanel or SSH."

          # Future: Implement automatic rollback to previous version
          # ssh ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }} << 'ENDSSH'
          #   cd ${{ env.DEPLOY_PATH }}
          #   git reset --hard HEAD~1
          #   npm install --production
          #   pm2 restart ihep-app
          # ENDSSH

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run security audit
        run: npm audit --production --audit-level=high

      - name: Check for exposed secrets
        run: |
          if ssh ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }} \
            "grep -r 'API_KEY\|SECRET\|PASSWORD' ${{ env.DEPLOY_PATH }}/.env* 2>/dev/null"; then
            echo "⚠️ Warning: Potential secrets found in deployed files"
            exit 1
          fi

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Clear CDN cache (if using Cloudflare)
        if: vars.CLOUDFLARE_ZONE_ID != ''
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ vars.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'

      - name: Warm up cache
        run: |
          # Make requests to key pages to warm up cache
          curl -s https://ihep.app/ > /dev/null
          curl -s https://ihep.app/dashboard > /dev/null
          echo "Cache warmed up"

      - name: Update deployment log
        run: |
          echo "Deployment completed successfully"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
